############################################################
# AI Tool Server Stack with External OAuth/OIDC SSO
# Environment Configuration
############################################################
# Copy this file to .env and update the values
# Run ./setup.sh to generate secure secrets automatically
############################################################

# ==============================================
# OAUTH/OIDC PROVIDER BASE CONFIGURATION
# ==============================================
# Base URL of your OAuth/OIDC provider
# Used by Langflow for OAuth integration
# Examples:
#   - Authentik: https://auth.yourdomain.com
#   - Keycloak: https://keycloak.yourdomain.com/realms/myrealm
#   - Auth0: https://yourtenant.auth0.com
OAUTH_PROVIDER_URL=https://auth.yourdomain.com

# ==============================================
# LANGFLOW CONFIGURATION
# ==============================================
LANGFLOW_VERSION=latest
LANGFLOW_PORT=7860
LANGFLOW_DB_NAME=langflow
LANGFLOW_DB_USER=langflow
# IMPORTANT: Generate a secure password with: openssl rand -hex 16
LANGFLOW_DB_PASSWORD=
LANGFLOW_LOG_LEVEL=INFO
LANGFLOW_WORKERS=1
LANGFLOW_AUTO_LOGIN=false

# Langflow URL (for OAuth callbacks)
LANGFLOW_URL=http://localhost:7860

# Langflow OAuth (configure in your OAuth provider)
# After creating OAuth application, add credentials here:
LANGFLOW_OAUTH_CLIENT_ID=
LANGFLOW_OAUTH_CLIENT_SECRET=

# NOTE: Langflow SSO support is experimental/pending
# Feature request: https://github.com/langflow-ai/langflow/issues/2855

# ==============================================
# OPEN WEBUI CONFIGURATION
# ==============================================
OPEN_WEBUI_VERSION=main
OPEN_WEBUI_PORT=8080

# Application Name (shown in UI)
WEBUI_NAME="Open WebUI"

# CRITICAL: Set this BEFORE enabling OAuth
OPEN_WEBUI_URL=http://localhost:8080

# IMPORTANT: Generate with: openssl rand -hex 32
WEBUI_SECRET_KEY=
WEBUI_AUTH=true

# ==============================================
# OPEN WEBUI OAUTH/OIDC CONFIGURATION
# ==============================================
# OAuth Provider Name (displayed to users during login)
OAUTH_PROVIDER_NAME=SSO

# Open WebUI OAuth/OIDC Configuration
# CRITICAL: Configure OPENID_PROVIDER_URL for your specific provider
# Examples:
#   - Authentik: https://auth.yourdomain.com/application/o/open-webui/.well-known/openid-configuration
#   - Keycloak: https://keycloak.yourdomain.com/realms/myrealm/.well-known/openid-configuration
#   - Google: https://accounts.google.com/.well-known/openid-configuration
#   - Microsoft: https://login.microsoftonline.com/YOUR_TENANT_ID/v2.0/.well-known/openid-configuration
OPENID_PROVIDER_URL=

# OAuth Client Credentials (from your OAuth provider)
OPEN_WEBUI_OAUTH_CLIENT_ID=
OPEN_WEBUI_OAUTH_CLIENT_SECRET=

# OAuth Settings
ENABLE_OAUTH_SIGNUP=true
ENABLE_OAUTH_PERSISTENT_CONFIG=true
OAUTH_MERGE_ACCOUNTS_BY_EMAIL=true
OAUTH_SCOPES="openid email profile"

# Password Authentication (set to false to disable local login, SSO only)
ENABLE_PASSWORD_AUTH=true

# Database: Open WebUI uses SQLite by default
# To use PostgreSQL instead, add DATABASE_URL to docker-compose.override.yml:
#   open-webui:
#     environment:
#       - DATABASE_URL=postgresql://user:password@host:port/database

# Optional: Supabase URL (defaults to Kong gateway)
SUPABASE_URL=

# ==============================================
# PLAYWRIGHT CONFIGURATION
# ==============================================
PLAYWRIGHT_VERSION=1.49.1

# ==============================================
# MEILISEARCH CONFIGURATION
# ==============================================
MEILISEARCH_VERSION=latest
MEILISEARCH_PORT=7700
MEILISEARCH_UI_PORT=7701
# CRITICAL: Generate with: openssl rand -hex 32
MEILI_MASTER_KEY=
MEILI_ENV=production
SCRAPIX_VERSION=latest

# ==============================================
# AI MODEL BACKENDS
# ==============================================
# Ollama Base URL (if running locally)
OLLAMA_BASE_URL=http://host.docker.internal:11434

# OpenAI API Key
OPENAI_API_KEY=

# Anthropic API Key
ANTHROPIC_API_KEY=

# OpenRouter API Key
OPENROUTER_API_KEY=

# ==============================================
# SUPABASE - GENERAL CONFIGURATION
# ==============================================
# Studio port (3001 to avoid conflicts with common dev servers)
STUDIO_PORT=3001
STUDIO_DEFAULT_ORGANIZATION="Default Organization"
STUDIO_DEFAULT_PROJECT="Default Project"

# External URLs (update for production)
# Default uses 'db' subdomain for all Supabase services
SUPABASE_PUBLIC_URL=http://localhost:8000
API_EXTERNAL_URL=http://localhost:8000
SITE_URL=http://localhost:3001

# Additional redirect URLs (comma separated)
ADDITIONAL_REDIRECT_URLS=

# ==============================================
# SUPABASE - DATABASE CONFIGURATION
# ==============================================
POSTGRES_HOST=db
POSTGRES_PORT=5432
POSTGRES_DB=postgres
# CRITICAL: Generate a secure password with: openssl rand -hex 16
POSTGRES_PASSWORD=

# PostgreSQL version
POSTGRES_VERSION=15.8.1.085

# Database schemas
PGRST_DB_SCHEMAS=public,storage,graphql_public

# ==============================================
# SUPABASE - JWT & SECRETS
# ==============================================
# CRITICAL: Run ./setup.sh to generate all secrets automatically
# Or generate manually:

# JWT Secret - Generate with: openssl rand -hex 32
JWT_SECRET=
JWT_EXPIRY=3600

# API Keys - Generate with: openssl rand -hex 32
# Or use JWT generator at https://supabase.com/docs/guides/self-hosting/docker
ANON_KEY=
SERVICE_ROLE_KEY=

# Secret Key Base - Generate with: openssl rand -hex 48 (minimum 64 chars)
SECRET_KEY_BASE=

# Crypto Keys - Generate with: openssl rand -hex 32
PG_META_CRYPTO_KEY=
VAULT_ENC_KEY=

# ==============================================
# SUPABASE - AUTHENTICATION
# ==============================================
DISABLE_SIGNUP=false
ENABLE_EMAIL_SIGNUP=true
ENABLE_EMAIL_AUTOCONFIRM=true
ENABLE_PHONE_SIGNUP=false
ENABLE_PHONE_AUTOCONFIRM=true
ENABLE_ANONYMOUS_USERS=false

# ==============================================
# SUPABASE - EMAIL/SMTP CONFIGURATION
# ==============================================
SMTP_ADMIN_EMAIL=admin@example.com
SMTP_HOST=smtp.example.com
SMTP_PORT=587
SMTP_USER=smtp_user
SMTP_PASS=smtp_password
SMTP_SENDER_NAME=Supabase
SMTP_USE_TLS=true

# Email template paths
MAILER_URLPATHS_INVITE=/auth/v1/verify
MAILER_URLPATHS_CONFIRMATION=/auth/v1/verify
MAILER_URLPATHS_RECOVERY=/auth/v1/verify
MAILER_URLPATHS_EMAIL_CHANGE=/auth/v1/verify

# ==============================================
# SUPABASE - API GATEWAY (KONG)
# ==============================================
KONG_VERSION=2.8.1
KONG_HTTP_PORT=8000
KONG_HTTPS_PORT=8443
DASHBOARD_USERNAME=supabase
# IMPORTANT: Generate with: openssl rand -hex 16
DASHBOARD_PASSWORD=

# ==============================================
# SUPABASE - ANALYTICS (LOGFLARE)
# ==============================================
LOGFLARE_VERSION=1.26.13
LOGFLARE_PORT=4001
# IMPORTANT: Generate with: openssl rand -hex 32
LOGFLARE_PUBLIC_ACCESS_TOKEN=
LOGFLARE_PRIVATE_ACCESS_TOKEN=

# ==============================================
# SUPABASE - STORAGE
# ==============================================
STORAGE_VERSION=1.32.0
IMGPROXY_VERSION=3.8.0
IMGPROXY_ENABLE_WEBP_DETECTION=true

# ==============================================
# SUPABASE - EDGE FUNCTIONS
# ==============================================
# Verify JWT for Edge Functions (set to false for development, true for production)
FUNCTIONS_VERIFY_JWT=false

# ==============================================
# SUPABASE - COMPONENT VERSIONS
# ==============================================
GOTRUE_VERSION=2.183.0
POSTGREST_VERSION=13.0.7
REALTIME_VERSION=2.65.3
META_VERSION=0.93.1
EDGE_RUNTIME_VERSION=1.69.25
VECTOR_VERSION=0.28.1-alpine
STUDIO_VERSION=2025.11.26-sha-8f096b5

# ==============================================
# SUPABASE - CONNECTION POOLER
# ==============================================
SUPAVISOR_VERSION=2.7.4
POOLER_PROXY_PORT_TRANSACTION=6543
POOLER_TENANT_ID=default
POOLER_DEFAULT_POOL_SIZE=20
POOLER_MAX_CLIENT_CONN=100
POOLER_DB_POOL_SIZE=10

# ==============================================
# SYSTEM CONFIGURATION
# ==============================================
DOCKER_SOCKET_LOCATION=/var/run/docker.sock

############################################################
# SETUP INSTRUCTIONS:
############################################################
# 1. Run ./setup.sh to generate secure secrets automatically
# 2. Update AUTHENTIK_URL to point to your Authentik instance
# 3. Update OPEN_WEBUI_URL, LANGFLOW_URL for your domain
# 4. Update SUPABASE_PUBLIC_URL, API_EXTERNAL_URL, SITE_URL
# 5. Configure SMTP settings if using email
# 6. Start stack: docker compose up -d
# 7. Configure OAuth providers in your Authentik instance
# 8. Add OAuth client credentials to this file
# 9. Restart services: docker compose restart open-webui langflow
############################################################

############################################################
# AUTHENTIK OAUTH SETUP GUIDE:
############################################################
# In your existing Authentik instance:
# 
# FOR OPEN WEBUI:
# 1. Admin Interface > Applications > Providers > Create
# 2. Select OAuth2/OpenID Provider
#    - Name: Open WebUI
#    - Authorization flow: default-provider-authorization-implicit-consent
#    - Client Type: Confidential
#    - Redirect URIs: http://localhost:8080/oauth/oidc/callback
#      (or https://your-domain.com/oauth/oidc/callback for production)
#    - Leave "Encryption Key" BLANK
#    - Copy Client ID and Client Secret
# 3. Applications > Applications > Create
#    - Name: Open WebUI
#    - Slug: open-webui
#    - Provider: Open WebUI (from step 2)
# 4. Update this .env file:
#    OPEN_WEBUI_OAUTH_CLIENT_ID=<from step 2>
#    OPEN_WEBUI_OAUTH_CLIENT_SECRET=<from step 2>
# 5. Restart: docker compose restart open-webui
# 6. Test at: http://localhost:8080
#
# FOR LANGFLOW (when supported):
# Repeat similar steps with:
#    - Redirect URI: http://localhost:7860/api/auth/callback/authentik
#    - Application slug: langflow
############################################################

############################################################
# NETWORK REQUIREMENTS:
############################################################
# Your services need network access to Authentik:
# - Open WebUI must reach: ${AUTHENTIK_URL}/application/o/open-webui/
# - Langflow must reach: ${AUTHENTIK_URL}/application/o/langflow/
#
# If Authentik is on the same Docker host:
#   Use: http://host.docker.internal:9000 (if Authentik on port 9000)
#
# If Authentik is on another machine:
#   Use: https://auth.yourdomain.com or http://192.168.1.x:9000
#
# Ensure firewall rules allow communication!
############################################################

############################################################
# SECURITY NOTES:
############################################################
# 1. Change ALL passwords and secrets before deployment
# 2. Use strong passwords (minimum 16 characters)
# 3. Never commit the .env file to version control
# 4. Restrict file permissions: chmod 600 .env
# 5. Use HTTPS in production with reverse proxy
# 6. Enable firewall rules to limit port access
# 7. Regular backups of ./volumes/ directory
# 8. Update images regularly for security patches
# 9. Ensure Authentik is properly secured (MFA, strong passwords)
# 10. Use HTTPS for Authentik in production
############################################################

############################################################
# QUICK START COMMANDS:
############################################################
# Generate secrets:
#   openssl rand -base64 32    # For most secrets
#   openssl rand -base64 48    # For SECRET_KEY_BASE
#
# Generate multiple secrets:
#   for i in {1..10}; do openssl rand -base64 32; done
#
# Start stack:
#   docker compose up -d
#
# View logs:
#   docker compose logs -f
#
# Test Authentik connectivity:
#   docker compose exec open-webui curl -I ${AUTHENTIK_URL}
#
# Access services:
#   Authentik:       ${AUTHENTIK_URL} (external)
#   Langflow:        http://localhost:7860
#   Open WebUI:      http://localhost:8080
#   Supabase Studio: http://localhost:3000
#   Supabase API:    http://localhost:8000
############################################################
