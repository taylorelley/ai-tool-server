############################################################
# AI Tool Server Stack with External Authentik SSO
# Environment Configuration
############################################################
# Copy this file to .env and update the values
# Run ./setup.sh to generate secure secrets automatically
############################################################

# ==============================================
# EXTERNAL AUTHENTIK SSO CONFIGURATION
# ==============================================
# URL of your existing Authentik instance
# Example: https://auth.yourdomain.com or http://192.168.1.100:9000
AUTHENTIK_URL=https://auth.yourdomain.com

# Note: You don't need Authentik database/Redis credentials
# since Authentik is already running elsewhere on your network

# ==============================================
# LANGFLOW CONFIGURATION
# ==============================================
LANGFLOW_VERSION=latest
LANGFLOW_PORT=7860
LANGFLOW_DB_NAME=langflow
LANGFLOW_DB_USER=langflow
LANGFLOW_DB_PASSWORD=changeme_langflow_password
LANGFLOW_LOG_LEVEL=INFO
LANGFLOW_WORKERS=1
LANGFLOW_AUTO_LOGIN=false

# Langflow URL (for OAuth callbacks)
LANGFLOW_URL=http://localhost:7860

# Langflow Authentik OAuth (configure in your Authentik instance)
# After creating OAuth provider in Authentik, add credentials here:
LANGFLOW_OAUTH_CLIENT_ID=
LANGFLOW_OAUTH_CLIENT_SECRET=

# NOTE: Langflow SSO support is experimental/pending
# Feature request: https://github.com/langflow-ai/langflow/issues/2855

# ==============================================
# OPEN WEBUI CONFIGURATION  
# ==============================================
OPEN_WEBUI_VERSION=main
OPEN_WEBUI_PORT=8080

# CRITICAL: Set this BEFORE enabling OAuth
OPEN_WEBUI_URL=http://localhost:8080

# Generate with: openssl rand -base64 32
WEBUI_SECRET_KEY=changeme_webui_secret_key
WEBUI_AUTH=true

# Open WebUI Authentik OAuth Configuration
# Fill these after creating OAuth provider in your Authentik instance:
OPEN_WEBUI_OAUTH_CLIENT_ID=
OPEN_WEBUI_OAUTH_CLIENT_SECRET=

# OAuth Settings
ENABLE_OAUTH_SIGNUP=true
ENABLE_LOCAL_LOGIN=true

# Optional: Use Supabase PostgreSQL instead of SQLite
# Format: postgresql://user:password@host:port/database
OPEN_WEBUI_DATABASE_URL=

# Optional: Supabase URL (defaults to Kong gateway)
SUPABASE_URL=

# ==============================================
# PLAYWRIGHT CONFIGURATION
# ==============================================
PLAYWRIGHT_VERSION=1.49.1

# ==============================================
# AI MODEL BACKEND (Ollama/OpenAI)
# ==============================================
# Ollama Base URL (if running locally)
OLLAMA_BASE_URL=http://host.docker.internal:11434

# OpenAI API Key (if using OpenAI)
OPENAI_API_KEY=

# ==============================================
# SUPABASE - GENERAL CONFIGURATION
# ==============================================
# Studio port
STUDIO_PORT=3000
STUDIO_DEFAULT_ORGANIZATION=Default Organization
STUDIO_DEFAULT_PROJECT=Default Project

# External URLs (update for production)
SUPABASE_PUBLIC_URL=http://localhost:8000
API_EXTERNAL_URL=http://localhost:8000
SITE_URL=http://localhost:3000

# Additional redirect URLs (comma separated)
ADDITIONAL_REDIRECT_URLS=

# ==============================================
# SUPABASE - DATABASE CONFIGURATION
# ==============================================
POSTGRES_HOST=db
POSTGRES_PORT=5432
POSTGRES_DB=postgres
# IMPORTANT: Change this password!
POSTGRES_PASSWORD=changeme_postgres_password

# PostgreSQL version
POSTGRES_VERSION=15.8.1.085

# Database schemas
PGRST_DB_SCHEMAS=public,storage,graphql_public

# ==============================================
# SUPABASE - JWT & SECRETS
# ==============================================
# Generate with: openssl rand -base64 32
JWT_SECRET=changeme_jwt_secret_minimum_32_characters_long
JWT_EXPIRY=3600

# Generate with: openssl rand -base64 32
# Or use JWT generator at https://supabase.com/docs/guides/self-hosting/docker
ANON_KEY=changeme_anon_key
SERVICE_ROLE_KEY=changeme_service_role_key

# Generate with: openssl rand -base64 48 (minimum 64 chars)
SECRET_KEY_BASE=changeme_secret_key_base_minimum_64_characters

# Generate with: openssl rand -base64 32
PG_META_CRYPTO_KEY=changeme_pg_meta_crypto_key

# Generate with: openssl rand -base64 32
VAULT_ENC_KEY=changeme_vault_enc_key

# ==============================================
# SUPABASE - AUTHENTICATION
# ==============================================
DISABLE_SIGNUP=false
ENABLE_EMAIL_SIGNUP=true
ENABLE_EMAIL_AUTOCONFIRM=true
ENABLE_PHONE_SIGNUP=false
ENABLE_PHONE_AUTOCONFIRM=true
ENABLE_ANONYMOUS_USERS=false

# ==============================================
# SUPABASE - EMAIL/SMTP CONFIGURATION
# ==============================================
SMTP_ADMIN_EMAIL=admin@example.com
SMTP_HOST=smtp.example.com
SMTP_PORT=587
SMTP_USER=smtp_user
SMTP_PASS=smtp_password
SMTP_SENDER_NAME=Supabase

# Email template paths
MAILER_URLPATHS_INVITE=/auth/v1/verify
MAILER_URLPATHS_CONFIRMATION=/auth/v1/verify
MAILER_URLPATHS_RECOVERY=/auth/v1/verify
MAILER_URLPATHS_EMAIL_CHANGE=/auth/v1/verify

# ==============================================
# SUPABASE - API GATEWAY (KONG)
# ==============================================
KONG_VERSION=2.8.1
KONG_HTTP_PORT=8000
KONG_HTTPS_PORT=8443
DASHBOARD_USERNAME=supabase
DASHBOARD_PASSWORD=changeme_dashboard_password

# ==============================================
# SUPABASE - ANALYTICS (LOGFLARE)
# ==============================================
LOGFLARE_VERSION=1.26.13
LOGFLARE_PORT=4001
# Generate with: openssl rand -base64 32
LOGFLARE_PUBLIC_ACCESS_TOKEN=changeme_logflare_public_token
LOGFLARE_PRIVATE_ACCESS_TOKEN=changeme_logflare_private_token

# ==============================================
# SUPABASE - STORAGE
# ==============================================
STORAGE_VERSION=1.32.0
IMGPROXY_VERSION=3.8.0
IMGPROXY_ENABLE_WEBP_DETECTION=true

# ==============================================
# SUPABASE - COMPONENT VERSIONS
# ==============================================
GOTRUE_VERSION=2.183.0
POSTGREST_VERSION=13.0.7
REALTIME_VERSION=2.65.3
META_VERSION=0.93.1
EDGE_RUNTIME_VERSION=1.69.25
VECTOR_VERSION=0.28.1-alpine
STUDIO_VERSION=2025.11.26-sha-8f096b5

# ==============================================
# SUPABASE - CONNECTION POOLER
# ==============================================
SUPAVISOR_VERSION=2.7.4
POOLER_PROXY_PORT_TRANSACTION=6543
POOLER_TENANT_ID=default
POOLER_DEFAULT_POOL_SIZE=20
POOLER_MAX_CLIENT_CONN=100
POOLER_DB_POOL_SIZE=10

# ==============================================
# SYSTEM CONFIGURATION
# ==============================================
DOCKER_SOCKET_LOCATION=/var/run/docker.sock

############################################################
# SETUP INSTRUCTIONS:
############################################################
# 1. Run ./setup.sh to generate secure secrets automatically
# 2. Update AUTHENTIK_URL to point to your Authentik instance
# 3. Update OPEN_WEBUI_URL, LANGFLOW_URL for your domain
# 4. Update SUPABASE_PUBLIC_URL, API_EXTERNAL_URL, SITE_URL
# 5. Configure SMTP settings if using email
# 6. Start stack: docker compose up -d
# 7. Configure OAuth providers in your Authentik instance
# 8. Add OAuth client credentials to this file
# 9. Restart services: docker compose restart open-webui langflow
############################################################

############################################################
# AUTHENTIK OAUTH SETUP GUIDE:
############################################################
# In your existing Authentik instance:
# 
# FOR OPEN WEBUI:
# 1. Admin Interface > Applications > Providers > Create
# 2. Select OAuth2/OpenID Provider
#    - Name: Open WebUI
#    - Authorization flow: default-provider-authorization-implicit-consent
#    - Client Type: Confidential
#    - Redirect URIs: http://localhost:8080/oauth/oidc/callback
#      (or https://your-domain.com/oauth/oidc/callback for production)
#    - Leave "Encryption Key" BLANK
#    - Copy Client ID and Client Secret
# 3. Applications > Applications > Create
#    - Name: Open WebUI
#    - Slug: open-webui
#    - Provider: Open WebUI (from step 2)
# 4. Update this .env file:
#    OPEN_WEBUI_OAUTH_CLIENT_ID=<from step 2>
#    OPEN_WEBUI_OAUTH_CLIENT_SECRET=<from step 2>
# 5. Restart: docker compose restart open-webui
# 6. Test at: http://localhost:8080
#
# FOR LANGFLOW (when supported):
# Repeat similar steps with:
#    - Redirect URI: http://localhost:7860/api/auth/callback/authentik
#    - Application slug: langflow
############################################################

############################################################
# NETWORK REQUIREMENTS:
############################################################
# Your services need network access to Authentik:
# - Open WebUI must reach: ${AUTHENTIK_URL}/application/o/open-webui/
# - Langflow must reach: ${AUTHENTIK_URL}/application/o/langflow/
#
# If Authentik is on the same Docker host:
#   Use: http://host.docker.internal:9000 (if Authentik on port 9000)
#
# If Authentik is on another machine:
#   Use: https://auth.yourdomain.com or http://192.168.1.x:9000
#
# Ensure firewall rules allow communication!
############################################################

############################################################
# SECURITY NOTES:
############################################################
# 1. Change ALL passwords and secrets before deployment
# 2. Use strong passwords (minimum 16 characters)
# 3. Never commit the .env file to version control
# 4. Restrict file permissions: chmod 600 .env
# 5. Use HTTPS in production with reverse proxy
# 6. Enable firewall rules to limit port access
# 7. Regular backups of ./volumes/ directory
# 8. Update images regularly for security patches
# 9. Ensure Authentik is properly secured (MFA, strong passwords)
# 10. Use HTTPS for Authentik in production
############################################################

############################################################
# QUICK START COMMANDS:
############################################################
# Generate secrets:
#   openssl rand -base64 32    # For most secrets
#   openssl rand -base64 48    # For SECRET_KEY_BASE
#
# Generate multiple secrets:
#   for i in {1..10}; do openssl rand -base64 32; done
#
# Start stack:
#   docker compose up -d
#
# View logs:
#   docker compose logs -f
#
# Test Authentik connectivity:
#   docker compose exec open-webui curl -I ${AUTHENTIK_URL}
#
# Access services:
#   Authentik:       ${AUTHENTIK_URL} (external)
#   Langflow:        http://localhost:7860
#   Open WebUI:      http://localhost:8080
#   Supabase Studio: http://localhost:3000
#   Supabase API:    http://localhost:8000
############################################################
